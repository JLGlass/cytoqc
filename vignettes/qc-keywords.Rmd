---
title: A QC tool for openCyto
output: rmarkdown::html_vignette
always_allow_html: yes
vignette: >
  %\VignetteIndexEntry{cytoqc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# cytoqc -- A QC tool for openCyto

*cytoqc* performs pre-cleaning, pre-gating and post-gating QC checks.

## The basic workflow:

1. Run `cqc_check` to see the summary
2. `cqc_set_reference` and `cqc_find_solution` for selected groups
3. `cqc_fix` based on the solution or `cqc_drop_groups` for unsolvable issues
4. Iterate 1~3 steps until data is cleaned
5. `split` the data into multiple sets for multi-panel cases

```{r include=FALSE}
library(knitr)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(kableExtra)
```


```{r}
library(flowCore)
library(flowWorkspace)
# library(cytoqc)
devtools::load_all("../")
```

```{r include=FALSE}
# prepare the test data
data("GvHD")
fs <- GvHD
data_dir <- tempfile()
dir.create(data_dir)
write.flowSet(fs, data_dir)
```

## Load the FCS

```{r}
files <- list.files(data_dir, ".fcs", full.names = TRUE)
cqc_data <- cqc_load_fcs(files)
cqc_data
```

```{r include=FALSE}
#clean up keywordnames
for(cf in cqc_data)
{
  kw <- keyword(cf)
  kn <- names(kw)
  kn <- gsub("^\\&[0-9]+", "", kn)
  names(kw) <- kn
  keyword(cf) <- kw
  
}
#simulate channel discrepancy

#case
cf <- cqc_data[[1]]
kw <- keyword(cf)
kn <- names(kw)
names(keyword(cf))[match("Patient ID", kn)] <- "patient id"

#missing
cf <- cqc_data[[2]]
kw <- keyword(cf)
kn <- names(kw)
keyword(cf) <- kw[-match("Patient ID", kn)]


#redundant
cf <- cqc_data[[3]]
kw <- keyword(cf)
kw[["new_kw"]] <- "test"
keyword(cf) <- kw


#typo
cf <- cqc_data[[4]]
kw <- keyword(cf)
kn <- names(kw)
names(keyword(cf))[match("Patient ID", kn)] <- "patien id"



```

## QC check for channel
```{r}
groups <- cqc_check(cqc_data, "keyword")
su <- summary(groups)
knit_print(su)
# knit_print(diff(su))
```

## Match against reference and report the discrepancy
```{r}
match_result <- cqc_match_reference(groups, ref = 4, select = c(1,2,3,6))
match_result
```

## Recommend the fix for the selected groups 
```{r}

solution <-  cqc_find_solution(match_result)
knit_print(solution)
```

## Apply the fix

```{r}
cqc_fix(solution)
```

## Drop group that has missing keyword
```{r}
cqc_data <- cqc_drop_groups(groups, 6)
```


## Continue QC on the rest groups
```{r}
res <- cqc_match_reference(groups, ref = 4, select = 5)
res
```

## Check the values of the keyword to see if they mean the same 
```{r}
sub_data <- cqc_get_data(groups, select = 5)
```

## Drop groups that can not be fixed
```{r}
cqc_data <- cqc_drop_groups(groups, 1)
length(cqc_data)
```

## Refresh QC report 
```{r}
groups <- cqc_check(cqc_data, "keyword")
knit_print(summary(groups))
```

## Further split the data by panel
```{r}
grps <- cqc_check(data_list[[2]], "panel")
diff(summary(grps))
split(grps)
```

