---
title: "cytoqc -- A QC tool for openCyto"
output:
  html_document: 
    keep_md: yes
---

*cytoqc* performs pre-cleaning, pre-gating and post-gating QC checks.

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(knitr)
library(kableExtra)
```


```{r}
library(flowCore)
library(flowWorkspace)
library(cytoqc)
```

```{r include=FALSE}
# prepare the test data
data("GvHD")
data_dir <- tempfile()
dir.create(data_dir)
write.flowSet(GvHD, data_dir)
```

## Load the FCS

```{r}
files <- list.files(data_dir, ".fcs", full.names = TRUE)
cq_data <- cq_load_fcs(files)
cq_data
```

```{r include=FALSE}
#simulate channel discrepancy

#case
cf <- cq_data[[1]]
colnames(cf)[1] <- "fsc-h"

#missing
cq_data[[1]] <- cf[,1:7]


#redundant
thisfile <- files[2]
fr <- read.FCS(thisfile)
new_col <- exprs(fr)[,8,drop=F]
colnames(new_col) <- "channelA"
fr <- cbind2(fr, new_col)
write.FCS(fr, files[2])
cq_data[[2]] <- load_cytoframe_from_fcs(thisfile, is_h5 = TRUE)

#typo
cf <- cq_data[[2]]
colnames(cf)[2] <- "SSC1-H"

#both case and typo
cf <- cq_data[[3]]
colnames(cf)[1:2] <- c("fsc-h", "SSC1-H")

#order
cf <- cq_data[[4]]
cf_swap_colnames(cf, "FL1-H", "FL2-H")

```
## QC for channels

### Determin the reference channels

```{r}
reference <- cq_find_reference_params(cq_data, type = "channel")
paste(reference, collapse = ", ")
```

### QC check
```{r}
check_results <- cq_check_params(cq_data, reference, type = "channel")
format(check_results)
```


### Propose the fix 
```{r}
solution <- cq_fix_param_solution(check_results) 
format(solution)
```

*Show the itemized details*
```{r}
format(solution, itemize = TRUE)
```


### Apply the fix
After reviewing the `solution` (revise it if needed), pass it to the `cq_fix_params`
```{r}
cq_fix_params(cq_data, solution)
```
### Update QC report
```{r}
check_results <- cq_check_params(cq_data, reference, type = "channel")
format(check_results)
```

### Drop redundant channel
```{r}
cq_data <- cq_drop_redundant_params(cq_data, check_results)
```
     
### Refresh QC report and drop the samples that still can not be fixed
```{r}
check_results <- cq_check_params(cq_data, reference, type = "channel")
format(check_results)
cq_data <- cq_drop_samples(cq_data, check_results)
length(cq_data)
```

### QC for marker
```{r eval=FALSE}
reference <- cq_find_reference_params(cq_data, type = "marker")
check_results <- cq_check_params(cq_data, reference, type = "marker")
format(check_results)
```



