---
title: "cytoqc -- A Quality Control tool for openCyto gating"
output:
  html_document: 
    keep_md: yes
    toc: yes
---

*cytoqc* performs pre-cleaning, pre-gating and post-gating QC checks.
```{r}
library(flowCore)
library(flowWorkspace)
library(cytoqc)
```

```{r cache=TRUE, include=FALSE}
# prepare the test data
data("GvHD")
data_dir <- tempfile()
dir.create(data_dir)
write.flowSet(GvHD, data_dir)
```

### 1. preload the data into h5-based `cytoframe` objects.

```{r}
files <- list.files(data_dir, ".fcs", full.names = TRUE)
cq_data <- cq_load_fcs(files)
cq_data
```

### 2. Precleaning and standardization
```{r include=FALSE}
#simulate channel discrepancy

#case
cf <- cq_data[[1]]
colnames(cf)[1] <- "fsc-h"

#typo
cf <- cq_data[[2]]
colnames(cf)[2] <- "SCC-H"

#order
cf <- cq_data[[3]]
colnames(cf)[1:2] <- c("fsc-h", "SSC1-H")

#missing
cf <- cq_data[[4]]
cq_data[[4]] <- cf[,1:7]

#redundant
fr <- read.FCS(files[5])
new_col <- exprs(fr)[,8,drop=F]
colnames(new_col) <- "channelA"
fr <- cbind2(fr, new_col)
write.FCS(fr, files[5])
cq_data[[5]] <- load_cytoframe_from_fcs(files[5], is_h5 = TRUE)

#order
cf <- cq_data[[6]]
cf_swap_colnames(cf, "FL1-H", "FL2-H")

```

#### 2.1 QC for parameters
2.1.1 *channels*
Firstly, automatically detect the reference channels by identifying the ones shared by the majority samples. 

```{r}
reference <- cq_find_reference_params(cq_data, type = "channel")
reference
```
This step can be skipped if you want to manually supply 'reference` .

Then run qc check after you've examined and verified the `reference` (and modifed if necessary)
```{r}
report <- cq_check_params(cq_data, reference, type = "channel")
report
```
Each row in the check report represent one problematic sample and three columns are:
* `FCS`: the sample file
* `unmatched`: the channels found in the sample but not expected from the reference
* `missing`: the channels that are expected but not present in the sample

E.g. We've found 5 samples that have mismatched channels. 
* `s10a01` has the case difference of `FSC` channel.
* `s10a02` has typo in `SSC` channel.
* `s10a03` has both above issues
* `s10a04` has `Time` channel missing from the data.
* `s10a05` has extra channel

After reviewing the report, you can fix these issues eithe by manually modifying the individual samples (stored as `cytoframe` object) from `cq_data` in place. e.g.
```{r}
cf <- cq_data[["s10a01.fcs"]]
colnames(cf)[1] <- "FSC-H"
```
Or use the convenient tool to correct them in batch. 
First, use the helper function to draft the fix solution 
```{r}
solution <- cq_fix_param_solution(report) 
```
Then review the `solution` and make adjustment or correction as needed, pass it to the `cq_fix_params`
```{r}
cq_fix_params(cq_data, solution)
```
The verify whethe the data has been cleaned, run the QA check again
```{r}
cq_check_params(cq_data, reference, type = "channel")
```
This should return an empty table, which indicates the problems are fixed. Otherwise, inspect and revise the `solution` to rerun the fix accordingly.


